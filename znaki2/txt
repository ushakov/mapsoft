Уже готовый программы:

./make_map_gk <map name> <scale, m/cm> <lon0> <x1> <x2> <y1> <y2>

-- Сделать заготовку карты с нужными параметрами.
   Проекция Г-К, СК Пулково-42

./update_map <map> <source> <conf_file> <file.mp|file.fig> <nc.fig>

-- обновить карту из mp или fig-файла 

Программа всасывает в систему карту с именем map, и именем источника source
(надо сюда писать свое имя :)) в соответствии с конфигурационным 
файлом conf_file. Из файла file.mp или file.fig. 
Все, что не удалось преобразовать сваливается в nc.fig.

Два обновления одной и той же картой не приводят ни к каким изменениям,
кроме других id новых объектов.

./get_map <map> <conf_file> <file.mp|file.fig>


============================================================

============================================================

    Хранилище карт

В системе имеется внутреннее хранилище карт. Карты хранятся в формате
xfig, но они не должны редактироваться напрямую, а должны помещаться в
хранилище, и обновляться специальными программами...

Действия с хранилищем могут быть такие:
* создать карту
* получить карту для редактирования в формате fig или mp
* внести исправления из отредактированной карты
* получить версию для печати/публикации
* получить табличку условных обозначений в виде fig или как-то еще
* обновить карту из внешнего источника
(сейчас три первых операции более-менее сделаны, остальные надеюсь 
сделать довольно быстро)


    Объекты на карте

Карта состоит из картографических объектов, подписей к ним, разных пометок,
часть из которых мы хотим печатать, а часть - не хотим...
Для разных типов объектов в fig-файле зарезервированы разные глубины:

50-399 -- картографические объекты. Если вы нарисуете в карте объект
такой глубины, система будет пытаться понять, какому условному
обозначению он соответствует, и будет ругаться в случае неудачи. Если вы
ничего такого не имеете в виду -- рисуйте в других  слоях. Здесь же
лежат подписи к объекту. Они обязательно должны иметь специальный ключ,
в котором записано, к какому объекту относятся. Подписи создаются
автоматически при помещении объекта в карты, а потом могут всячески
редактироваться пользователем.

45-49  -- Временные объекты. Объекты такой глубины не попадают в карту.
Используется это для изготовления разных точечных объектов
сложного вида. Внутри хранилища карт точечные знаки хранятся в виде точек
определенного цвета, размера и глубины. Однако при редактировании
карт такие такие разноцветные точки неудобны - их много разных, в них легко 
запутаться. Поэтому, когда карта выдается из хранилища для редактирования,
точечные объекты помещаются в составной объект вместе с разными картинками.
Например, для церкви рисуется прямой крестик, а для перевала - наклонный.
Эти дополнительные объекты рисуются в слоях 45-49, и при обновлении карты
после редактирования тихо исчезают...

40-44  -- сетка. Эти объекты рисуются на карте для печати, причем
когда-нибудь хочется сделать, чтоб печатались они в полупрозрачном виде.

30-39  -- печатные пометки (легенда и т.п.).  Эти объекты рисуются на
карте для печати поверх сетки.

1-29, 400-999 -- разные пометки. Не попадают в версию для печати, не 
рассматриваются, как картографические объекты, но хранятся в карте.
Обычно на глубине 1 лежит привязка карты, в глубины 5-7 программа 
mapsoft_add2fig добавляет точки и треки, в глубины больше 400 удобно
класть растровые исходники для карты...


    Система условных обозначений

Принятая система условных обозначений читается из специального
конфигурационного файла. Конфигурационный файл записан в формате YAML и
должен содержать список таких объектов:

  name: <название объекта>
  desc: <подробное описание объекта>
  mp:   <маска для тестового mp-объекта>
  fig:  <маска для тестового fig-объекта>
  txt:  <маска fig-объекта для подписи>
  pic:  <имя fig-файла с картинкой>

(Обратите внимание, что пользовательские цвета в fig-заголовке
даны в виде числа 0x1RRGGBB в десятичном виде.)

Идентификатором условного обозначения является число - тип объекта,
равное типу тестового mp-объекта + 0x100000 для линиейных объектов,
+ 0x100000 для площадных объектов.

При помещении нового объекта в карту, система пытается  понять, какому
условному обозначению он соответствует. Для этого новый объект
сравнивается c тестовым следующим образом:

- если объект - текст, то должны совпасть глубина, цвет и шрифт.

- если объект - точка, то должны совпасть глубина, толщина, цвет и округлость
  (-- с округлостью пока проблемы, кажется --)

- если объект - линия, то должны совпасть толщина, глубина, тип заливки,
  если толщина не 0, то, кроме того, цвет и тип линии, если заливка не
  прозрачная - то цвет заливки, если заливка штриховая - то цвет линии (даже
  если толщина линии 0).

В результате таких сравнений определяется тип объекта.
см. int zn_conv::get_type (const fig::fig_object & o);

Внутри системы объект идентифицируется только по типу. Поэтому можно,
например, двум людям иметь два разных конфигурационных файла
(один рисует дороги синим цветом, а другой - черным) и получать
для редактирования или обновлять карту в соответствии со своей
конфигурацией.


    Ключ картографического объекта

При помещении в хранилище каждый картографический объект 
получает уникальный ключ такого вида:

<тип> <дата> <время> <id>@<map> [[<sid>@]source]

* тип объекта
* дата вида 2007-12-03
* время вида 15:26:16
* id - уникальный номер объекта в карте
* map - название карты
* sid - уникальный номер объекта в источнике (нужен, чтобы 
  автоматически обновлять карту из этого источника)
* source - название источника

В fig-объекте ключ записывается во второй строчке комментария 
(в первой строчке - название объекта)
В mp-объекте ключ записывается в первой строчке комментария.

Тип mp-объекта всегда определяется по его mp-типу,
а не по ключу.

Тип fig-объекта, имеющего ключ определяется по ключу.
Так что, если перекрасить, например, овраг под дорогу,
то он оврагом и останется...


    Подписи

Подписи к объектам имеет специальный ключ вида

+<id>@<map>

показывающий, к какому объекту относится подпись.
Подпись создается автоматически при добавлении нового
объекта.

Если вы хотите автоматически создать подпись заново - поменяйте 
координаты объекта или сотрите в нем ключ.





