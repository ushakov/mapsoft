MAPSOFT2.1

----------------------------------------------------------------------

    Что это такое

mapsoft - это набор библиотек и программ для работы с геоданными,
растровыми и векторными картами и т.п. Никакой общей концепции пока не
существует, поэтому библиотеки и программы весьма разрозненны...

Мы не ставим себе цель сделать серьезную ГИС-систему, а хотим.
решать простые бытовые задачи: смотреть треки и точки на картах,
делать векторные карты для туристского ориентирования и т.п.

Поскольку в полном наборе программ (mapsoft2) иногда встречаются вещи
странные, плохо документированные, противорячащие друг другу и
здравому смыслу, попробуем постепенно дорабатыввать и выкладывать некоторые
наиболее полезные, устоявшиеся вещи, и назовем
это - mapsoft-2.1, -2.2, и т.п. :)

----------------------------------------------------------------------

    Системные требования

Для компиляции нужны следующие библиотеки:.
 * boost/spirit
 * boost/operators
 * boost/lexical_cast

 * libusb - связь с gps-приемником через usb

 * libtiff, libjpeg, libpng - чтение соответствующих форматов
 * libgd        - рисование линий и т.п. на растровых картинках
 * gtkmm-2.0    - графический интерфейс

 * для сборки программ требуется scons
 * документация по библиотекам создается с помошью doxygen

Мы пишем программы под Linux. Кажется, их удавалось скомпилировать и
под MacOS. Можно ли скомпилировать их под Windows - неясно, никаких
теоретических препятствий тому, вроде бы, нет.

----------------------------------------------------------------------

    Авторы

Mapsoft пишут В.Завьялов и М.Ушаков, в последнее время им помогает
Т.Алексеевский.

В mapsoft вставлена (в немного модифицированном виде) замечательная
библиотека jeeps для работы с геоданными и для связи с приемниками
garmin. Авторы и домашняя страница этой библиотеки нам не известны.
Она распространяется под GPL и встречается в интернете, например, в
качестве части программы gpsbabel.

Для обсуждений технических вопросов существуют журналы
http://community.livejournal.ru/mapsoft
http://www.npj.ru/gps_soft

----------------------------------------------------------------------

    Программы

Текущий замысел состоит в том, чтобы устроить следующие программы:

mapsoft_convert -- различные преобразования геоданных. Читаем геоданные,
преобразуем их и записываем в файл. Здесь же - склейка растровых карт,
добавление геоданных и растровых карт в geofig и т.п...

mapsoft_vmap -- работа с векторными картами. Кажется, что для  карты
надо создавать локальный репозиторий с соответствующими действиями:
create, commit, checkout, update_from_mp, update_from_fig и т.п.
Тут надо еще подумать, как все обустроить правильно.

mapsoft_srtm -- работа с srtm-данными. Изготовление mp-файлов 
с разными вещами.

mapsoft_mapview -- просмотр и редактирование геоданных

Разные мелочи, типа gimp-plugin'a для привязывания номенклатурных карт

----------------------------------------------------------------------

    Программа mapsoft_convert - преобразования геоданных

mapsoft_convert <infile1> .. <infileN> -p <par1> .. -p <parN> -o <outfile>

Программа читает геоданные из файлов <infile1> .. <infileN> и
записывает их в файл <outfile>. Параметры <par1> .. <parN> влияют на
стандартное поведение программы.

Мы работаем с тремя типами данных: набор точек, трек, привязка карты.
К привязке карты обычно прилагается еще и растровая картинка, которую 
мы тоже можем как-то преобразовывать.

Формат читаемого файла обычно определяется по его содержимому, формат
записываемого файла - по его расширению.

Если файл - символьное устройство или если имя файла - "usb:",
программа читает или пишет данные в gps-приемник Garmin через это
устройство или через libusb.

Чтение производится из файлов следующих форматов:



Описание поддерживаемых форматов и параметров, которые влияют на
чтение и запись данных:

* xml: собственный xml-подобный формат, позволяющий хранить
  данные без потери информации по сравнению с внутренним
  представлением. При записи используется расширение ".xml".

* OziExplorer: широко распространенный формат. В одном файле хранится
  ровно один трек, один набор точек или одна привязка карты. Набор 
  параметров, описывающих геоданные, почти совпадает с нашим
  внутренним представлением.

* geofig: специальное расширение формата fig, очень для нас важное.
  Ниже есть более подробное описание этого формата.

* garmin-utils: достаточно бедный формат, включенный сюда по
  историческим соображениям. Поддерживается чтение и запись треков и
  точек.

* kml: поддерживается только запись треков и точек.

* Приемники Garmin: с помощью библиотеки jeeps поддерживается чтение 
  и запись через USB и RS232 (работа через RS232, кажется, пока не 
  проверена).

При преобразовании карт мы понимаем растроевые форматы jpeg, tiff 
(частично?), png (на чтение - кроме interlaced, на запись - 
только 24bpp) и векторные форматы xfig и mp.

----------------------------------------------------------------------

    Модули ввода-вывода, параметры

----------------------------------------------------------------------

    Геодезические допущения и соглашения.

Все координаты хранятся в градусах WGS84. Высота при преобразованиях
СК не преобразуется.

Сейчас при работе с картами поддерживаются практически только
две проекции: равноугольная поперечно-цилиндрическая проекция.
Гаусса-Крюгера (transverse mercator, tmerc) и проекции Lon/Lat (lonlat).
При этом мы не храним информацию о системе координат в которой была
нарисована карта и о параметрах проекции ГК, считая, что замена этих
параметров с хорошей точностью является линейным преобразованием.

Таким образом, любое преобразование карты сводится к преобразованию
latlon->tmerc или обратному (если это нужно) и линейному преобразованию,
которое находится по точкам привязки (минимизацией среднеквадратичного
отклонения, если точек более трех). Координаты точек привязки, конечно
же, преобразуются честно, заботясь о правильных преобразованиях 
систем координат и построений правильных проекций.

Замечательность такого подхода заключается в том, что для карт,
нарисованных в проекции Гаусса-Крюгера (а в большинстве случаев мы с
такими и работаем) нам необходимы только линейные
преобразования, что сильно убыстряет дело!

(написать про величину искажений из-за такого допущения)

Существенная ошибка такого подхода видна, например, при склейке
нескольких десятикилометровок, если линия вертикальной склейки
находится далеко от осевого меридиана.

(хорошо бы упорядочить работу с параметрами проекций, добавить
другие типы проекций)

----------------------------------------------------------------------


